module("simplicityState");

test("get/set state", function() {
  expect(5);

  var stateElement = $('#state');
  stateElement.simplicityState();
  deepEqual(
      stateElement.simplicityState('state'),
      {},
      'Initial empty state');

  stateElement.simplicityState('state', {});
  deepEqual(
    stateElement.simplicityState('state'),
    {},
    'Do nothing update');

  stateElement.simplicityState('state', {a: 1});
  deepEqual(
    stateElement.simplicityState('state'),
    {a: 1},
    'Add a param');

  stateElement.simplicityState('state', {});
  deepEqual(
    stateElement.simplicityState('state'),
    {},
    'Remove a param');

  stateElement.simplicityState('state', {b: 2});
  deepEqual(
    stateElement.simplicityState('state'),
    {b: 2},
    'Add a different param');
});

test("event simplicityStateChange", function() {
  expect(17);

  var stateElement = $('#state');
  stateElement.simplicityState();

  var events = [];
  var eventRecordingHandler = function (event, state) {
    events.push({event: event, state: state});
  };
  stateElement.bind('simplicityStateChange', eventRecordingHandler);

  deepEqual(
      stateElement.simplicityState('state'),
      {},
      'Initial empty state');
  equal(0, events.length, 'No events on copyState');

  stateElement.simplicityState('state', {});
  equal(1, events.length, 'Single events on first state set which allows for event propagation');
  events.length = 0;

  stateElement.simplicityState('state', {});
  equal(0, events.length, 'No events on state reset which does nothing');
  events.length = 0;

  stateElement.simplicityState('state', {a: 1});
  equal(events.length, 1, 'One event on update');
  deepEqual(
      events[0].state,
      {a: 1},
      'One event on update');
  events.length = 0;

  stateElement.simplicityState('state', {a: 1});
  equal(events.length, 0, 'No events on update which causes sets value to same');
  events.length = 0;

  stateElement.simplicityState('state', {a: 2});
  equal(events.length, 1, 'One event on update which changes existing value');
  deepEqual(
      events[0].state,
      {a: 2},
      'One event on update which changes existing value');
  events.length = 0;

  stateElement.simplicityState('state', {});
  equal(events.length, 1, 'One event on state reset');
  deepEqual(
      events[0].state,
      {},
      'One event on state reset');
  events.length = 0;

  stateElement.simplicityState('state', {a: 1}, false);
  equal(events.length, 0, 'No events on quiet state update');
  deepEqual(
      stateElement.simplicityState('state'),
      {a: 1},
      'Quiet state update');
  events.length = 0;

  stateElement.simplicityState('state', {});
  equal(events.length, 0, 'No events on state reset to last triggered state');
  deepEqual(
      stateElement.simplicityState('state'),
      {},
      'Reset dirty state to previous triggered state');
  events.length = 0;

  stateElement.simplicityState('state', {}, true);
  equal(events.length, 1, 'One event on forced update');
  deepEqual(
      events[0].state,
      {},
      'Forced update');
  events.length = 0;
});

test("order of simplicityStateChange", function() {
  expect(4);

  var events = [];
  var eventRecordingHandler = function (event, state) {
    events.push({event: event, state: state});
  };

  var stateElement = $('#state');
  stateElement.simplicityState();
  stateElement.bind('simplicityStateChange', eventRecordingHandler);

  var state = {a: 1, z:2};
  stateElement.simplicityState('state', state);
  equal(events.length, 1, 'One event on initial setup');
  events.length = 0;

  delete state.a;
  state.a = 1;
  stateElement.simplicityState('state', state);
  equal(events.length, 0, 'No events on reorder');
  events.length = 0;

  state = {z: 2, a: 1};
  stateElement.simplicityState('state', state);
  equal(events.length, 0, 'No events on new with different order');
  events.length = 0;

  state.a = 2;
  stateElement.simplicityState('state', state);
  equal(events.length, 1, 'One event on final change');
  events.length = 0;
});

